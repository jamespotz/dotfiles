- name: Setup ArchLinux
  hosts: localhost
  become: true
  connection: local
  gather_facts: true
  vars:
    aur_user: "{{ aur_user }}"

  tasks:
    - name: Update pacman database
      community.general.pacman:
        update_cache: yes

    - name: Install reflector to refresh mirrors
      community.general.pacman:
        name: reflector
        state: present
    
    - name: Update pacman mirrors (fastest in Asia)
      ansible.builtin.command: >
        reflector --country 'Philippines','Singapore','Japan'
                  --latest 10 --protocol https --sort rate
                  --save /etc/pacman.d/mirrorlist
      become: yes

    - name: Install packages
      community.general.pacman:
        name:
          - base-devel
          - pkgconf
          - cmake
          - ninja
          - gdb
          - lldb
          - git
          - git-delta
          - neovim
          - docker
          - docker-compose
          - fzf
          - lazydocker
          - lazygit
          - starship
          - eza
          - ripgrep
          - btop
          - bat
        state: present

    - name: Allow {{ aur_user }} to run pacman without password
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ aur_user }}-pacman"
        content: "{{ aur_user }} ALL=(ALL) NOPASSWD: /usr/bin/pacman\n"
        mode: "0440"
      become: yes

    - name: Install AUR packages
      become_user: "{{ aur_user }}"
      kewlfft.aur.aur:
        name:
          - fnm
          - mcfly
          - zoxide
          - wezterm
          - fd
          - zsh-antidote
          - mesa
          - vulkan-dzn
          - vulkan-icd-loader
          - yay
        state: present
        use: yay

    - name: Detect zsh binary path
      ansible.builtin.shell: command -v zsh || true
      register: zsh_path
      changed_when: false

    - name: Ensure detected zsh path is in /etc/shells
      ansible.builtin.lineinfile:
        path: /etc/shells
        line: "{{ zsh_path.stdout }}"
        state: present

    - name: Change default shell to detected zsh for that user
      ansible.builtin.user:
        name: "{{ aur_user }}"
        shell: "{{ zsh_path.stdout }}"

    - name: Add Docker group
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ aur_user }}"
        groups: docker
        append: true

    - name: Remove temporary passwordless sudo file
      ansible.builtin.file:
        path: "/etc/sudoers.d/99-{{ aur_user }}"
        state: absent
